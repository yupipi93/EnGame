ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 1.
Hexadecimal [16-Bits]



                              1 .area _CODE 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 2.
Hexadecimal [16-Bits]



                              2 .include "cpctelera.h.s"
                              1 ;; CPCtelera Symbols
                              2 .globl cpct_drawSolidBox_asm
                              3 .globl cpct_getScreenPtr_asm
                              4 
                              5 .globl cpct_scanKeyboard_asm
                              6 .globl cpct_isKeyPressed_asm
                              7 
                              8 .globl cpct_waitVSYNC_asm
                              9 .globl cpct_disableFirmware_asm
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 3.
Hexadecimal [16-Bits]



                              3 
                              4 
                              5 
                              6 
                              7 ;;####################################
                              8 ;; PRIVATE DATA
                              9 ;;####################################
                             10 
                             11 
                             12 ;; enemy Data
   0000 4F                   13 enemy_x: 		.db #80-1		;;End of screen
   0001 52                   14 enemy_y: 		.db #82
   0002 01                   15 enemy_w: 		.db #1 			;;Whidth
   0003 04                   16 enemy_h: 		.db #4 			;;Height
                             17 
   0004 01                   18 direccion:		.db #1			;; 1 = left, 2 = right
                             19 
                             20 
                             21 
                             22 
                             23 
                             24 ;;####################################
                             25 ;; PUBLIC FUNCTIONS ::
                             26 ;;####################################
                             27 
                             28 ;;====================================
                             29 ;; Gets a pointer to Enemy data in DE
                             30 ;; DESTROY: DE
                             31 ;; RETURN: 
                             32 ;; 		DE: Pointer to Player data
                             33 ;;====================================
   0005                      34 enemy_getPtrDE::
   0005 11 00 00      [10]   35 	ld 	de, #enemy_x					;; DE: pointer to player data
   0008 C9            [10]   36 ret
                             37 
                             38 ;;====================================
                             39 ;; Check collition
                             40 ;; Inputs:
                             41 ;;		HL: Points to the oder entity to check collition
                             42 ;; Return:
                             43 ;; 		A: #0x0F = ON, #00 = OFF
                             44 ;;====================================
   0009                      45 enemy_checkCollision::
   0009 1E 00         [ 7]   46 	ld 	e, #0 				;; E = Collisions_Counter
                             47 	;; Collision in X:
   000B CD 23 00      [17]   48 	call ifPlayerLeft 		;; Check if player is Left, if not (E++)
   000E CD 35 00      [17]   49 	call ifPlayerRigth		;; Check if player is Right, if not (E++)
                             50 	;; Collision in Y:
   0011 CD 49 00      [17]   51 	call ifPlayerUp 		;; Check Collition in Y (E++)
                             52 	;;call ifPlauerDown 		;; Check Collition in Y (E++)
                             53 
   0014 7B            [ 4]   54 	ld 	a, e 				;; |
   0015 FE 03         [ 7]   55 	cp 	#3 					;; if Collisions_Counter == 2 (not left + not right)
   0017 28 04         [12]   56 	jr	z,led_on 			;; LED_ON
   0019 CD 20 00      [17]   57 	call led_off 			;; Then LED_OFF
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 4.
Hexadecimal [16-Bits]



   001C C9            [10]   58 ret
                             59 
                             60 ;; Collision
   001D                      61 led_on:
   001D 3E 0F         [ 7]   62 	ld 		a, #0x0F
   001F C9            [10]   63 ret
                             64 
                             65 ;; No collision
   0020                      66 led_off:
   0020 3E 00         [ 7]   67 	ld 		a, #00
   0022 C9            [10]   68 ret
                             69 	
                             70 	
                             71 
                             72 
   0023                      73 	ifPlayerLeft:
                             74 		;; if (EX+EW <= PX) collision_off
                             75 		;;  	(EX+EW - PX <= 0) 
   0023 3A 00 00      [13]   76 		ld 		a, (enemy_x) 			;; Enemy_X
   0026 4F            [ 4]   77 		ld 		c, a 					;; +
   0027 3A 02 00      [13]   78 		ld  	a, (enemy_w) 			;; Enemy_Whidth
   002A 81            [ 4]   79 		add 	c 						;; -
   002B 96            [ 7]   80 		sub 	(hl) 					;; Player_X???
   002C 28 30         [12]   81 		jr 		z, collision_off 		;; if(Resultado == 0) NOT COLLITION
   002E FA 5E 00      [10]   82 		jp 		m, collision_off 		;; if(Resultado < 0) NOT COLLITION
   0031 CD 5C 00      [17]   83 		call 	collision_on			;; COLLISION
   0034 C9            [10]   84 	ret
                             85 
                             86 
   0035                      87 	ifPlayerRigth:	
                             88 		;; IF (PX+PWE <= EX) --> (PX+PW-EX <= 0)
   0035 7E            [ 7]   89 		ld 		a, (hl) 				;; Player_X
   0036 23            [ 6]   90 		inc 	hl 						;; HL++ (HL+1 = Player_Y)
   0037 23            [ 6]   91 		inc 	hl 						;; HL++ (HL+2 = Player_Width)
   0038 86            [ 7]   92 		add 	(hl) 					;; Player_X + Player_Whidth
   0039 4F            [ 4]   93 		ld 		c, a 					;;
   003A 3A 00 00      [13]   94 		ld 		a, (enemy_x) 			;; Enemy_X
   003D 47            [ 4]   95 		ld 		b, a 					;; B = Enemy_X
   003E 79            [ 4]   96 		ld 		a, c 					;; A = Player_X + Player_Whidth
   003F 90            [ 4]   97 		sub 	b   					;; Player_X + Player_Whidth  - Enemy_X
   0040 28 1C         [12]   98 		jr 		z, collision_off 		;; if(Resultado == 0) NOT COLLITION
   0042 FA 5E 00      [10]   99 		jp 		m, collision_off 		;; if(Resultado < 0) NOT COLLITION
   0045 CD 5C 00      [17]  100 		call 	collision_on
   0048 C9            [10]  101 	ret
                            102 
                            103 	;; Other Posibilities Y
                            104 
   0049                     105 	ifPlayerUp:
                            106     	;; If(EY >= PY+PH) --> if(EY - PY+PH >= 0)
   0049 23            [ 6]  107     	inc 	hl 					;; | (After HL+2) Load Player DATA (X,Y,W,H)
   004A 7E            [ 7]  108     	ld 		a, (hl)  			;; A = Player_H
   004B 2B            [ 6]  109     	dec 	hl 					;; HL--
   004C 2B            [ 6]  110     	dec 	hl 					;; HL-- = Player_Y
   004D 86            [ 7]  111     	add 	(hl) 				;; |
   004E 4F            [ 4]  112     	ld 		c, a 				;; C = Player_H + Player_Y
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 5.
Hexadecimal [16-Bits]



   004F 3A 01 00      [13]  113     	ld 		a, (enemy_y) 		;; |
   0052 91            [ 4]  114     	sub 	c 					;; Enemy_Y - C
   0053 28 09         [12]  115     	jr 		z,collision_off 	;; if (== 0) NOT COLLISION
   0055 F2 5E 00      [10]  116     	jp 		p,collision_off     ;; if (<) 0) NOT COLLISION
   0058 CD 5C 00      [17]  117     	call 	collision_on
   005B C9            [10]  118 	ret
                            119 
   005C                     120 	collision_on:
   005C 1C            [ 4]  121     	inc 	e
   005D C9            [10]  122 	ret
                            123 
   005E                     124 	collision_off:
                            125 		;;Nothing
   005E C9            [10]  126 	ret
                            127 
                            128 
                            129 
                            130 
                            131 
                            132 ;;====================================
                            133 ;; Erase th enemy
                            134 ;;====================================
                            135 
   005F                     136 enemy_erase::
   005F 3E 00         [ 7]  137 	ld a, #0x00							;;Erase enemy (Backgrownd Color)
   0061 CD B3 00      [17]  138 	call drawEnemy  					;;Draw enemy :D
                            139 
   0064 C9            [10]  140 ret
                            141 
                            142 ;;====================================
                            143 ;; Update the enemy
                            144 ;;====================================
                            145 
   0065                     146 enemy_update::
   0065 CD 6F 00      [17]  147 	call updateEnemy	
   0068 C9            [10]  148 ret
                            149 
                            150 ;;====================================
                            151 ;; Draw the enemy
                            152 ;;====================================
                            153 
   0069                     154 enemy_draw::
   0069 3E F0         [ 7]  155 	ld a, #0xF0							;;enemy Color RED
   006B CD B3 00      [17]  156 	call drawEnemy  					;;Draw enemy :D 
                            157 
   006E C9            [10]  158 ret
                            159 
                            160 
                            161 
                            162 
                            163 
                            164 
                            165 ;;####################################
                            166 ;; PRIVATE FUNCTIONS
                            167 ;;####################################
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 6.
Hexadecimal [16-Bits]



                            168 
                            169 
                            170 
                            171 ;;====================================
                            172 ;; Move enemy right-left
                            173 ;; DESTROY: AF
                            174 ;;====================================
                            175 
   006F                     176 updateEnemy:
   006F 3A 00 00      [13]  177 	ld 	a,(enemy_x) 					;; Load Enemy_X
   0072 FE 4E         [ 7]  178 	cp 	#80-2 							;; |
   0074 28 08         [12]  179 	jr	z, changeToLeft 				;; if (Enemy_X == 79){ changeToLeft (dirrection = 1) }
   0076 FE 00         [ 7]  180 	cp 	#0 								;; |
   0078 28 0D         [12]  181 	jr	z, changeToRight 				;; else if (Enemy_X == 0) { changeToRight (direcction = 2)}
                            182 
   007A CD 90 00      [17]  183 	call moveTo							;; else {move player to direccion}
                            184 
   007D C9            [10]  185 ret
                            186 
                            187 
                            188 
   007E                     189 changeToLeft: 							
   007E 3E 01         [ 7]  190 	ld 	a, #1 							;; |
   0080 32 04 00      [13]  191 	ld 	(direccion), a 					;; A = 1
   0083 CD 90 00      [17]  192 	call moveTo 						;; Move enemy to direction
   0086 C9            [10]  193 ret
                            194 
                            195 
   0087                     196 changeToRight:
   0087 3E 02         [ 7]  197 	ld 	a, #2 							;; |
   0089 32 04 00      [13]  198 	ld 	(direccion), a 					;; A = 2
   008C CD 90 00      [17]  199 	call moveTo 						;; Move Enemy to direction
   008F C9            [10]  200 ret
                            201 
                            202 
   0090                     203 moveTo:
   0090 3A 04 00      [13]  204 	ld 	a, (direccion) 					;; A = direction
   0093 FE 01         [ 7]  205 	cp 	#1 								;; |
   0095 28 10         [12]  206 	jr 	z, moveEnemyLeft 				;; if (direction = 1 [LEFT]) {Move Enemy to Left}
   0097 CD 9B 00      [17]  207 	call moveEnemyRight					;; else {Move enmey to Right}
                            208 
   009A C9            [10]  209 ret
                            210 
                            211 
                            212 
                            213 ;;====================================
                            214 ;; Move enemy Right
                            215 ;; DESTROY: AF
                            216 ;;====================================
   009B                     217 moveEnemyRight:
                            218 
   009B 3A 00 00      [13]  219 	ld a, (enemy_x)					;; A = enemy_x
   009E FE 4E         [ 7]  220 	cp #80-2							;; Check if A is (limit of screen - enemy width)
   00A0 28 04         [12]  221 	jr z, dont_move_r						;; Dont move the enemy
                            222 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 7.
Hexadecimal [16-Bits]



   00A2 3C            [ 4]  223 		inc a 							;; Else: A++
   00A3 32 00 00      [13]  224 		ld (enemy_x), a 				;; enemy_x Update
                            225 
   00A6                     226 	dont_move_r:
   00A6 C9            [10]  227 ret
                            228 
                            229 
                            230 
                            231 ;;====================================
                            232 ;; Move enemy Left
                            233 ;; DESTROY: AF
                            234 ;;====================================
   00A7                     235 moveEnemyLeft:
                            236 
   00A7 3A 00 00      [13]  237 	ld a, (enemy_x)					;; A == enemy_x
   00AA FE 00         [ 7]  238 	cp #0								;; Check if enemy (screen rigth limit)
   00AC 28 04         [12]  239 	jr z, dont_move_l
                            240 	 
   00AE 3D            [ 4]  241 		dec a 							;; Else: A-- (enemy_X--)
   00AF 32 00 00      [13]  242 		ld (enemy_x), a 				;; enemy_x Update 
                            243 
   00B2                     244 	dont_move_l:
   00B2 C9            [10]  245 ret
                            246 
                            247 
                            248 
                            249 
                            250 ;;====================================
                            251 ;; Draw enemy
                            252 ;; INPUTS:
                            253 ;; 		A ==> Color Patern
                            254 ;; DESTROY: AF, BC, DE, HL
                            255 ;;====================================
   00B3                     256 drawEnemy:
                            257 	
   00B3 F5            [11]  258 	push af 							;; Save A in Stack
                            259 	;;Calculate scrren position
   00B4 11 00 C0      [10]  260 	ld 		de, #0xC000					;;Video Memory Pointer
   00B7 3A 00 00      [13]  261 	ld 		 a, (enemy_x)				;;|
   00BA 4F            [ 4]  262 	ld 		 c, a 						;; C = enemy_x
   00BB 3A 01 00      [13]  263 	ld 		 a, (enemy_y)				;;|
   00BE 47            [ 4]  264 	ld 		 b, a 						;; B = enemy_y
   00BF CD 00 00      [17]  265 	call 	cpct_getScreenPtr_asm		;; Get Pointer to Screen (return to HL)
                            266 	
                            267 
                            268 	;; Draw a box
   00C2 EB            [ 4]  269 	ex 		de, hl 						;; intercabia ambos valores DE --> to Screen Pointer 
   00C3 F1            [10]  270 	pop 	af							;; A = User Selecter Color
   00C4 01 01 04      [10]  271 	ld 		bc, 	#0x0401				;; 4x4 pixeles
   00C7 CD 00 00      [17]  272 	call 	 cpct_drawSolidBox_asm		;; Llamar dibujar solidBox
                            273 
   00CA C9            [10]  274 ret
                            275 
                            276 
                            277 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 8.
Hexadecimal [16-Bits]



                            278 
                            279 
                            280 
